<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>V-TEST UNIT</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: monospace; color: #fff; }
        #ui { position: absolute; top: 0; width: 100%; padding: 20px; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }
        input { background: #222; border: 1px solid #555; color: #fff; padding: 8px; width: 150px; }
        button { background: #00aaff; border: none; color: #000; padding: 8px 15px; font-weight: bold; }
        #status { color: #555; font-weight: bold; }
        .connected { color: #0f0 !important; text-shadow: 0 0 10px #0f0; }
    </style>
</head>
<body>

    <div id="ui">
        <div>STATUS: <span id="status">DISCONNECTED</span></div>
        <div style="font-size: 10px; margin-top: 5px; opacity: 0.7;">MY ID: <span id="my-id" style="color:#00aaff">...</span></div>
        
        <div class="interactive" style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
            <input type="text" id="partner-id" placeholder="Enter Other Phone ID">
            <button id="btn-connect">LINK</button>
        </div>
        <div style="margin-top: 20px; font-size: 10px; color: #555;">TAP SCREEN TO TEST VIBRATION</div>
    </div>

    <div id="canvas-container" style="width:100vw; height:100vh;"></div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

        // --- 1. VISUALS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 3;
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const geo = new THREE.IcosahedronGeometry(1, 1);
        const mat = new THREE.MeshBasicMaterial({ color: 0x00aaff, wireframe: true });
        const heart = new THREE.Mesh(geo, mat);
        scene.add(heart);

        function animate() {
            requestAnimationFrame(animate);
            heart.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        animate();

        // --- 2. CONNECTION (PeerJS) ---
        const peer = new Peer(); 
        let conn = null;

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
        });

        document.getElementById('btn-connect').addEventListener('click', () => {
            const pid = document.getElementById('partner-id').value;
            if(!pid) return alert("Enter ID!");
            conn = peer.connect(pid);
            setupConnection();
        });

        peer.on('connection', (c) => {
            conn = c;
            setupConnection();
        });

        function setupConnection() {
            document.getElementById('status').innerText = "CONNECTED";
            document.getElementById('status').className = "connected";
            
            conn.on('data', (data) => {
                if(data.type === 'touch') {
                    // REMOTE TOUCH DETECTED
                    flashColor(0xff0055); // Pink
                    if(navigator.vibrate) navigator.vibrate([50, 50, 200]);
                }
            });
        }

        // --- 3. INTERACTION ---
        function flashColor(hex) {
            mat.color.setHex(hex);
            heart.scale.setScalar(1.2);
            setTimeout(() => {
                mat.color.setHex(0x00aaff); // Back to Blue
                heart.scale.setScalar(1.0);
            }, 200);
        }

        window.addEventListener('touchstart', () => {
            flashColor(0xffffff); // White for local touch
            if(conn) conn.send({ type: 'touch' });
            if(navigator.vibrate) navigator.vibrate(20);
        });
    </script>
</body>
</html>

