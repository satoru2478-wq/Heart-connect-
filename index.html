<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOUL LINK SOFT</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; user-select: none; }
        
        /* BLACKOUT LAYER */
        #blackout {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: none;
        }

        /* NOTIFICATION TEXT */
        #notify-text {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 20px; font-weight: 300; letter-spacing: 5px;
            opacity: 0; z-index: 101; pointer-events: none; transition: opacity 1s; width: 100%; text-align: center;
        }

        /* UI LAYER */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; transition: opacity 0.5s;
        }

        .glass-card {
            background: rgba(10, 10, 10, 0.8); 
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(15px); padding: 30px; border-radius: 24px; text-align: center; 
            width: 80%; max-width: 320px;
        }

        .key { font-size: 30px; color: #fff; font-weight: 200; letter-spacing: 3px; margin-bottom: 20px;}
        .status { margin-top: 15px; font-size: 10px; color: #555; letter-spacing: 1px; }
        .active-status { color: #00ff66; text-shadow: 0 0 10px #00ff66; }

        input { 
            background: #000; border: 1px solid #333; color: #fff; padding: 12px; 
            width: 100%; border-radius: 10px; text-align: center; font-size: 16px; 
            outline: none; text-transform: uppercase; margin-bottom: 10px;
        }

        button { 
            background: #fff; color: #000; border: none; padding: 12px; 
            width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; 
        }

        /* ACTION BAR */
        #action-bar {
            position: absolute; bottom: 30px; display: flex; gap: 20px; 
            z-index: 20; opacity: 0; pointer-events: none; transition: 1s;
        }
        
        .icon-btn {
            width: 50px; height: 50px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.1); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; background: rgba(0,0,0,0.5);
        }
        .pink-glow { border-color: #ff66aa; color: #ff66aa; }
        .show { opacity: 1; pointer-events: auto; }
        
        canvas { display: block; position: absolute; top:0; left:0; z-index: 1; }
    </style>
</head>
<body>

    <div id="notify-text">Thinking of You...</div>
    <div id="blackout"></div>

    <div id="ui">
        <div class="glass-card">
            <div style="color:#666; font-size:10px; letter-spacing:3px; margin-bottom:20px;">SOUL LINK</div>
            <div id="my-id" class="key">...</div>
            
            <div id="setup-box">
                <input type="text" id="partner-id" placeholder="PARTNER KEY" maxlength="6">
                <button id="btn-link">CONNECT</button>
            </div>
            
            <div id="status" class="status">v16 SOFT TOUCH</div>
        </div>
    </div>

    <div id="action-bar">
        <div id="btn-miss" class="icon-btn pink-glow">♥</div> 
        <div id="btn-sleep" class="icon-btn">⏻</div> 
    </div>

    <canvas id="canvas"></canvas>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        // --- 1. CONFIG ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function trigger(type, isRemote) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            pulse = 1.0;
            
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            if(type === 'touch') {
                // SOFT HEARTBEAT SOUND
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(50, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.15); // Shorter duration
                gain.gain.setValueAtTime(0.8, now); // Slightly quieter
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
                
                // SOFT VIBRATION
                if(navigator.vibrate) {
                    if(isRemote) navigator.vibrate([30, 50, 30]); // Short, gentle double-tap
                    else navigator.vibrate(10); // Tiny tick for you
                }
            } 
            else if (type === 'miss') {
                // MISS YOU SOUND
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 2);
                gain.gain.setValueAtTime(0.2, now); // Quiet
                gain.gain.exponentialRampToValueAtTime(0.001, now + 2);
                
                if(isRemote) {
                    const txt = document.getElementById('notify-text');
                    txt.style.opacity = 1;
                    setTimeout(() => txt.style.opacity = 0, 4000);
                }

                // GENTLE WAVE VIBRATION
                if(navigator.vibrate && isRemote) navigator.vibrate([200]); // One medium pulse
            }

            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(now); osc.stop(now + 2);
        }

        // --- 2. STEALTH MODE ---
        const blackout = document.getElementById('blackout');
        const sleepBtn = document.getElementById('btn-sleep');
        const ui = document.getElementById('ui');
        let wakeLock = null;

        sleepBtn.addEventListener('click', async () => {
            blackout.style.display = 'block';
            ui.style.opacity = 0;
            ui.style.pointerEvents = 'none';
            document.getElementById('action-bar').classList.remove('show');
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            if(navigator.vibrate) navigator.vibrate(20);
        });

        blackout.addEventListener('pointerdown', () => {
            trigger('touch', false);
            if(conn && conn.open) conn.send({type:'touch'});
        });

        // --- 3. CANVAS ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let w, h, cx, cy;
        function resize() { w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; cx=w/2; cy=h/2; }
        window.addEventListener('resize', resize); resize();

        let hue=0, pulse=0;
        function draw() {
            if(blackout.style.display === 'block') { requestAnimationFrame(draw); return; }

            ctx.clearRect(0,0,w,h);
            hue+=0.2;
            let color = `hsl(${hue}, 60%, 45%)`; // Darker, richer colors
            if(pulse>0.01) color = `hsl(${hue}, 100%, ${45+pulse*50}%)`;

            ctx.save(); ctx.translate(cx,cy);
            const s = 60+(pulse*40);
            
            ctx.beginPath();
            ctx.moveTo(0,-s*0.3); 
            ctx.bezierCurveTo(-s*0.5,-s*0.8,-s,-s*0.5,-s,0);
            ctx.bezierCurveTo(-s,s*0.5,-s*0.5,s*0.8,0,s*1.2);
            ctx.bezierCurveTo(s*0.5,s*0.8,s,s*0.5,s,0);
            ctx.bezierCurveTo(s,-s*0.5,s*0.5,-s*0.8,0,-s*0.3);
            
            ctx.shadowBlur=pulse*100; ctx.shadowColor=color; ctx.fillStyle=color; ctx.fill(); 
            ctx.restore();

            pulse*=0.92;
            requestAnimationFrame(draw);
        }
        draw();

        // --- 4. AUTO-CONNECTION ---
        let peer, conn;
        let myId = localStorage.getItem('v-id') || Math.random().toString(36).substring(2,8).toUpperCase();
        localStorage.setItem('v-id', myId);
        let savedPartner = localStorage.getItem('v-partner');

        peer = new Peer(myId);
        
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            if(savedPartner) {
                document.getElementById('setup-box').style.display = 'none';
                document.getElementById('status').innerText = "SEARCHING...";
                connect(savedPartner);
            }
        });

        peer.on('connection', (c) => handle(c));

        document.getElementById('btn-link').addEventListener('click', () => {
            const pid = document.getElementById('partner-id').value.toUpperCase();
            if(!pid) return;
            localStorage.setItem('v-partner', pid);
            connect(pid);
        });

        function connect(pid) { handle(peer.connect(pid)); }

        function handle(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('setup-box').style.display = 'none';
                document.getElementById('status').innerText = "CONNECTED";
                document.getElementById('status').className = "status active-status";
                document.getElementById('action-bar').classList.add('show');
                trigger('touch', true);
            });
            conn.on('data', (d) => {
                if(d.type === 'touch') trigger('touch', true);
                if(d.type === 'miss') trigger('miss', true);
            });
            conn.on('close', () => {
                document.getElementById('status').innerText = "RECONNECTING...";
                document.getElementById('status').className = "status";
                setTimeout(() => connect(savedPartner), 2000);
            });
        }

        document.getElementById('btn-miss').addEventListener('click', () => {
            if(conn && conn.open) {
                conn.send({type:'miss'});
                if(navigator.vibrate) navigator.vibrate(20);
            }
        });

        canvas.addEventListener('pointerdown', () => {
            trigger('touch', false);
            if(conn && conn.open) conn.send({type:'touch'});
        });
        
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').then(r => r.update());

    </script>
</body>
</html>
