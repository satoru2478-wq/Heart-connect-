<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V-LINK FLUID</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; touch-action: none; user-select: none; }
        
        /* UI LAYER - Permanent and Clear */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
            box-sizing: border-box; pointer-events: auto; z-index: 10;
        }
        
        .box {
            background: rgba(10, 10, 15, 0.9); border: 1px solid #333;
            padding: 15px; border-radius: 8px; margin-bottom: 10px;
            color: #ccc; backdrop-filter: blur(4px);
        }
        
        .label { font-size: 10px; color: #666; margin-bottom: 5px; letter-spacing: 2px; }
        .id-text { font-size: 20px; font-weight: bold; color: #fff; letter-spacing: 1px; }
        
        input { 
            background: #000; border: 1px solid #444; color: #fff; padding: 10px; 
            width: 100px; text-transform: uppercase; font-family: monospace; 
            border-radius: 4px; font-size: 16px; outline: none;
        }
        
        button { 
            background: #fff; color: #000; border: none; padding: 10px 15px; 
            font-weight: bold; border-radius: 4px; cursor: pointer; 
        }
        
        #status { font-size: 10px; margin-top: 10px; color: #555; }
        .connected-text { color: #0f0 !important; text-shadow: 0 0 10px #0f0; }

        canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="box">
            <div class="label">YOUR KEY</div>
            <div id="my-id" class="id-text">Loading...</div>
        </div>

        <div class="box">
            <div class="label">PARTNER KEY</div>
            <div style="display:flex; gap: 10px;">
                <input type="text" id="partner-id" placeholder="ENTER KEY" maxlength="6">
                <button id="btn-link">CONNECT</button>
            </div>
            <div id="status">STATUS: WAITING...</div>
        </div>
        
        <div style="text-align: center; color: #444; font-size: 10px; margin-top: 10px;">
            v5.0 (Updated)
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        // --- 1. SETUP CANVAS ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let w, h, cx, cy;
        
        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            cx = w / 2;
            cy = h / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 2. AUDIO (Soft Heartbeat) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playThud() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            osc.type = 'triangle'; // Softer than sine
            osc.frequency.setValueAtTime(50, audioCtx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(1, audioCtx.currentTime + 0.3);
            
            // Lowpass filter to make it sound "underwater/internal"
            filter.type = 'lowpass';
            filter.frequency.value = 100;

            gain.gain.setValueAtTime(0.8, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        // --- 3. FLUID VISUALS ---
        let time = 0;
        let ripples = [];
        let pulseStrength = 0;

        function draw() {
            // Background Fade
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, w, h);

            time += 0.03;

            // 1. Draw Ripples
            for(let i = ripples.length - 1; i >= 0; i--) {
                const r = ripples[i];
                ctx.beginPath();
                ctx.arc(r.x, r.y, r.size, 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(${r.r}, ${r.g}, ${r.b}, ${r.life})`;
                ctx.lineWidth = 2;
                ctx.stroke();
                r.size += 4;
                r.life -= 0.01;
                if(r.life <= 0) ripples.splice(i, 1);
            }

            // 2. Draw Fluid Core (The Puddle)
            ctx.save();
            ctx.translate(cx, cy);
            
            ctx.beginPath();
            const points = 20;
            const baseRadius = 50 + (pulseStrength * 30);
            
            for (let i = 0; i <= points; i++) {
                const angle = (i / points) * Math.PI * 2;
                // Soft liquid math
                const offset = Math.sin(angle * 3 + time) * 10 + Math.cos(angle * 2 - time) * 10;
                const r = baseRadius + offset;
                const x = Math.cos(angle) * r;
                const y = Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();

            // Color Logic
            let hue = (time * 10) % 360; // Rotating rainbow
            let color = `hsl(${hue}, 60%, 50%)`;
            
            if(pulseStrength > 0.1) {
                // Flash pink/white on touch
                color = `hsl(340, 100%, ${50 + pulseStrength * 50}%)`; 
            }

            ctx.fillStyle = color;
            ctx.shadowBlur = 30;
            ctx.shadowColor = color;
            ctx.fill();
            ctx.restore();

            // Calm down pulse
            if(pulseStrength > 0) pulseStrength *= 0.95;

            requestAnimationFrame(draw);
        }
        draw();

        // --- 4. INTERACTION ---
        function triggerTouch(x, y, isRemote) {
            // Visuals
            pulseStrength = 1.0;
            const r = isRemote ? 255 : 0;
            const g = isRemote ? 0 : 170;
            const b = isRemote ? 100 : 255;
            ripples.push({ x: x || cx, y: y || cy, size: 40, life: 1, r: r, g: g, b: b });

            // Sound
            playThud();

            // Vibrate
            if(navigator.vibrate) {
                // Double heartbeat pattern
                navigator.vibrate(isRemote ? [50, 50, 100] : 15);
            }
        }

        window.addEventListener('pointerdown', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            
            // Unlock audio on first touch
            if(audioCtx.state === 'suspended') audioCtx.resume();

            triggerTouch(e.clientX, e.clientY, false);
            
            if(conn && conn.open) {
                conn.send({ type: 'touch' });
            }
        });

        // --- 5. STABLE CONNECTION LOGIC ---
        let peer, conn;

        function initPeer() {
            // Generate Random 6-Char ID
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            peer = new Peer(id);

            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
            });

            peer.on('connection', (c) => {
                conn = c;
                setupConn();
            });

            peer.on('error', (err) => {
                document.getElementById('status').innerText = "ERROR: " + err.type;
            });
        }
        initPeer(); // Run immediately

        document.getElementById('btn-link').addEventListener('click', () => {
            const pid = document.getElementById('partner-id').value.toUpperCase();
            if(!pid) return;
            document.getElementById('btn-link').innerText = "...";
            conn = peer.connect(pid);
            setupConn();
        });

        function setupConn() {
            document.getElementById('status').innerText = "CONNECTED";
            document.getElementById('status').className = "connected-text";
            document.getElementById('btn-link').innerText = "LINKED";
            document.getElementById('partner-id').style.display = 'none'; // Hide input to look cleaner
            
            // Send test pulse
            triggerTouch(cx, cy, true);

            conn.on('data', (data) => {
                if(data.type === 'touch') triggerTouch(cx, cy, true);
            });
            
            conn.on('open', () => {
                 document.getElementById('status').innerText = "CONNECTED";
                 document.getElementById('status').className = "connected-text";
            });
        }
        
        // Register new SW
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.update(); // Check for updates immediately
            });
        }

    </script>
</body>
</html>
