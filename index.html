<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOID HEART</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        /* PURE BLACK BACKGROUND */
        body { margin: 0; overflow: hidden; background: #000000; font-family: 'Segoe UI', sans-serif; touch-action: none; user-select: none; }
        
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; transition: opacity 1s;
        }

        /* DARKER GLASS UI */
        .glass {
            background: rgba(10, 10, 10, 0.6); /* Much darker glass */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 40px; border-radius: 20px;
            text-align: center; width: 85%; max-width: 300px;
        }

        .key { font-size: 32px; color: #fff; letter-spacing: 4px; margin: 25px 0; font-weight: 300; opacity: 0.9; }
        .label { color: #555; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; }

        input { 
            background: #000; border: 1px solid #333; color: #fff; padding: 15px; 
            width: 100%; border-radius: 12px; text-align: center; font-size: 18px; 
            margin-bottom: 15px; outline: none; box-sizing: border-box; text-transform: uppercase; 
        }
        
        button { 
            background: #222; color: #fff; border: 1px solid #444; 
            padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; 
            cursor: pointer; letter-spacing: 1px;
        }

        .hidden { opacity: 0; pointer-events: none; }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="glass">
            <div class="label">Unit Key</div>
            <div id="my-id" class="key">...</div>
            
            <input type="text" id="partner-id" placeholder="PARTNER KEY" maxlength="6">
            <button id="btn-link">CONNECT</button>
            <div id="status" style="margin-top:20px; font-size: 10px; color: #333;">v9.0 DARK MODE</div>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let w, h, cx, cy;

        function resize() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
            cx = w / 2;
            cy = h / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- HEAVY HEARTBEAT AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playHeartbeat() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            // OSC 1: The "LUB" (Deep Thud)
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            
            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(60, now);
            osc.frequency.exponentialRampToValueAtTime(30, now + 0.15);
            
            filter.type = 'lowpass';
            filter.frequency.value = 120; // Muffles the sound to make it deep

            gain.gain.setValueAtTime(1.0, now); // Max Volume
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
            
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(now);
            osc.stop(now + 0.2);

            // OSC 2: The "DUB" (Secondary Echo)
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            const filter2 = audioCtx.createBiquadFilter();

            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(50, now + 0.15);
            osc2.frequency.exponentialRampToValueAtTime(20, now + 0.3);
            
            filter2.type = 'lowpass';
            filter2.frequency.value = 100;

            gain2.gain.setValueAtTime(0.6, now + 0.15);
            gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.4);

            osc2.connect(filter2);
            filter2.connect(gain2);
            gain2.connect(audioCtx.destination);

            osc2.start(now + 0.15);
            osc2.stop(now + 0.45);
        }

        // --- HEART VISUALS ---
        let hue = 0;
        let pulse = 0;

        function draw() {
            // Pure Black Clear (No trails)
            ctx.clearRect(0, 0, w, h);
            
            // Color Logic
            hue += 0.2; 
            let color = `hsl(${hue}, 70%, 50%)`; // Slightly darker base color
            if(pulse > 0.01) {
                // Flash Bright on touch
                color = `hsl(${hue}, 100%, ${50 + (pulse * 50)}%)`; 
            }

            ctx.save();
            ctx.translate(cx, cy);
            
            // Pulse Scale
            const scale = 50 + (pulse * 40); 
            
            ctx.beginPath();
            // Heart Shape
            ctx.moveTo(0, -scale * 0.3);
            ctx.bezierCurveTo(-scale * 0.5, -scale * 0.8, -scale, -scale * 0.5, -scale, 0);
            ctx.bezierCurveTo(-scale, scale * 0.5, -scale * 0.5, scale * 0.8, 0, scale * 1.2);
            ctx.bezierCurveTo(scale * 0.5, scale * 0.8, scale, scale * 0.5, scale, 0);
            ctx.bezierCurveTo(scale, -scale * 0.5, scale * 0.5, -scale * 0.8, 0, -scale * 0.3);
            
            // Glow (Only appears when pulsing)
            ctx.shadowBlur = pulse * 100;
            ctx.shadowColor = color;
            ctx.fillStyle = color;
            ctx.fill();
            ctx.restore();

            pulse *= 0.92; // Decay
            requestAnimationFrame(draw);
        }
        draw();

        // --- INTERACTION ---
        function trigger(isRemote) {
            pulse = 1.0;
            playHeartbeat();
            
            // MAX VIBRATION PATTERN
            // [Thud, wait, Thud] -> 200ms is heavy
            if(navigator.vibrate) {
                navigator.vibrate([200, 50, 200]); 
            }
        }

        window.addEventListener('pointerdown', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            trigger(false);
            if(conn && conn.open) conn.send({ type: 'touch' });
        });

        // --- CONNECT ---
        let peer, conn;
        // Generate ID
        const id = Math.random().toString(36).substring(2, 8).toUpperCase();
        peer = new Peer(id);
        
        peer.on('open', (id) => document.getElementById('my-id').innerText = id);
        peer.on('connection', (c) => handle(c));
        
        document.getElementById('btn-link').addEventListener('click', () => {
            const pid = document.getElementById('partner-id').value.toUpperCase();
            if(!pid) return;
            document.getElementById('btn-link').innerText = "...";
            handle(peer.connect(pid));
        });

        function handle(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('ui').classList.add('hidden');
                trigger(true);
            });
            conn.on('data', () => trigger(true));
        }
        
        // Update SW
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => reg.update());
        }

    </script>
</body>
</html>
