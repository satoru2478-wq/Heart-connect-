<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LIQUID LINK</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        /* OVERLAY UI */
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 20px; box-sizing: border-box; pointer-events: none; z-index: 10; color: rgba(255,255,255,0.6); display: flex; flex-direction: column; gap: 10px; }
        .interactive { pointer-events: auto; }
        
        .id-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); }
        .big-id { font-size: 20px; color: #fff; font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        input { background: rgba(0,0,0,0.5); border: 1px solid #555; color: #fff; padding: 8px; border-radius: 4px; width: 120px; text-transform: uppercase; font-family: monospace; }
        button { background: #fff; color: #000; border: none; padding: 8px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        #tap-start { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 99; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; letter-spacing: 2px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="tap-start">TAP TO INITIALIZE FLUID ENGINE</div>

    <div id="ui">
        <div class="id-box interactive">
            <div style="font-size: 10px; margin-bottom: 5px;">UNIT ID</div>
            <div id="my-id" class="big-id">...</div>
        </div>
        
        <div class="id-box interactive">
            <div style="font-size: 10px; margin-bottom: 5px;">LINK TO PARTNER</div>
            <div style="display:flex; gap: 10px;">
                <input type="text" id="target-id" placeholder="ENTER ID">
                <button id="btn-link">LINK</button>
            </div>
            <div id="status" style="margin-top:5px; font-size: 10px; color: #888;">STATUS: OFFLINE</div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
    
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 4;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap pixel ratio for performance
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.enablePan = false;
        controls.enableZoom = false;

        // --- 2. THE FLUID DROPLET ---
        // We use a high-detail sphere and modify its shape every frame
        const geometry = new THREE.IcosahedronGeometry(1, 30); // High detail for smoothness
        
        // Custom Material to look like liquid/glass
        const material = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            roughness: 0.1,
            metalness: 0.1,
            transmission: 0.9, // See-through like water
            thickness: 1.0,
            clearcoat: 1.0,
            clearcoatRoughness: 0.1,
        });

        const drop = new THREE.Mesh(geometry, material);
        scene.add(drop);

        // Internal Glow Sphere
        const coreGeo = new THREE.IcosahedronGeometry(0.6, 10);
        const coreMat = new THREE.MeshBasicMaterial({ color: 0x00aaff, wireframe: true, transparent: true, opacity: 0.3 });
        const core = new THREE.Mesh(coreGeo, coreMat);
        scene.add(core);

        // Lighting
        const light1 = new THREE.DirectionalLight(0xffffff, 2);
        light1.position.set(1, 1, 2);
        scene.add(light1);
        const ambient = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambient);

        // --- 3. FLUID ANIMATION LOGIC ---
        const simplex = new SimplexNoise();
        const originalPositions = geometry.attributes.position.array.slice(); // Copy original shape
        let time = 0;
        let spikeAmount = 0; // Controls how "agitated" the water is

        function updateLiquid() {
            time += 0.005;
            spikeAmount *= 0.95; // Slowly calm down automatically

            const positions = geometry.attributes.position.array;
            const colorTime = Date.now() * 0.0005;

            // Update Color (Rainbow Cycle)
            const hue = (colorTime % 1); // Cycle 0 to 1
            const color = new THREE.Color().setHSL(hue, 0.8, 0.5);
            coreMat.color = color;
            
            // If agitated (touched), flash white/bright
            if (spikeAmount > 0.1) {
                material.emissive = color;
                material.emissiveIntensity = spikeAmount * 0.5;
            } else {
                material.emissiveIntensity = 0;
            }

            // Deform the Sphere
            for (let i = 0; i < positions.length; i += 3) {
                const x = originalPositions[i];
                const y = originalPositions[i + 1];
                const z = originalPositions[i + 2];

                // Create Noise (Wobble)
                const v = new THREE.Vector3(x, y, z);
                v.normalize();
                
                // Base wobble + Spike wobble
                const noise = simplex.noise3D(x + time, y + time, z + time);
                const distortion = 1 + (noise * (0.1 + spikeAmount * 0.4));

                positions[i] = v.x * distortion;
                positions[i + 1] = v.y * distortion;
                positions[i + 2] = v.z * distortion;
            }
            geometry.attributes.position.needsUpdate = true;
            geometry.computeVertexNormals(); // Keep lighting correct
        }

        // --- 4. INTERACTION ---
        function triggerRipple(isRemote) {
            spikeAmount = 1.0; // Max agitation
            
            // Haptics
            if(navigator.vibrate) navigator.vibrate(isRemote ? [50, 50, 100] : 15);
            
            // Send to partner
            if (!isRemote && conn) conn.send({ type: 'touch' });
        }

        window.addEventListener('mousedown', () => triggerRipple(false));
        window.addEventListener('touchstart', (e) => {
            if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                e.preventDefault();
                triggerRipple(false);
            }
        }, { passive: false });

        // --- 5. ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            updateLiquid();
            drop.rotation.y += 0.002;
            core.rotation.y -= 0.005;
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- 6. CONNECTION (PEERJS) ---
        const peer = new Peer(); 
        let conn = null;

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
            document.getElementById('tap-start').style.display = 'none'; // Auto hide if loaded
        });

        document.getElementById('tap-start').addEventListener('click', function() {
            this.style.display = 'none';
        });

        document.getElementById('btn-link').addEventListener('click', () => {
            const target = document.getElementById('target-id').value;
            if(!target) return;
            document.getElementById('btn-link').innerText = "...";
            conn = peer.connect(target);
            setupConn();
        });

        peer.on('connection', (c) => {
            conn = c;
            setupConn();
        });

        function setupConn() {
            document.getElementById('status').innerText = "STATUS: CONNECTED";
            document.getElementById('status').style.color = "#0f0";
            document.getElementById('btn-link').innerText = "LINKED";
            
            conn.on('data', (data) => {
                if(data.type === 'touch') triggerRipple(true);
            });
        }

    </script>
</body>
</html>
