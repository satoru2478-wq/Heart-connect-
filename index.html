<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>V-LINK STABLE</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; color: white; }
        
        /* ERROR LOG (For Debugging) */
        #console-log { position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(20,0,0,0.8); color: #ff5555; font-size: 10px; overflow-y: scroll; z-index: 100; pointer-events: none; padding: 5px; display: none; }

        /* UI */
        #ui { position: absolute; top: 0; width: 100%; padding: 15px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }
        
        .box { background: rgba(0, 20, 40, 0.9); border: 1px solid #00aaff; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .big-text { font-size: 20px; color: #00aaff; font-weight: bold; text-shadow: 0 0 10px #00aaff; letter-spacing: 2px; }
        .label { font-size: 10px; color: #888; margin-bottom: 5px; }

        input { background: #000; border: 1px solid #555; color: white; padding: 8px; width: 100px; text-transform: uppercase; }
        button { background: #00aaff; border: none; padding: 8px 15px; font-weight: bold; cursor: pointer; }
        
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 50; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; }
        
        .green-status { color: #0f0; text-shadow: 0 0 5px #0f0; }
    </style>
</head>
<body>

    <div id="console-log"></div>

    <div id="start-screen">
        <div style="font-size: 40px; margin-bottom: 20px;">â—‰</div>
        <div>TAP TO ACTIVATE</div>
        <div style="font-size: 10px; color: #555; margin-top: 10px;">V-SYSTEM v4.0</div>
    </div>

    <div id="ui">
        <div class="box interactive">
            <div class="label">YOUR UNIT ID</div>
            <div id="my-id" class="big-text">CONNECTING...</div>
        </div>

        <div class="box interactive">
            <div class="label">TARGET ID</div>
            <div style="display:flex; gap: 10px;">
                <input type="text" id="partner-id" placeholder="ENTER ID">
                <button id="btn-link">LINK</button>
            </div>
            <div id="status" style="margin-top: 10px; font-size: 12px; color: #666;">STATUS: WAITING</div>
        </div>
    </div>

    <div id="canvas-container" style="position:fixed; top:0; left:0; width:100vw; height:100vh;"></div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script type="importmap">
      { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script>
        // ON-SCREEN LOGGER
        function log(msg) {
            console.log(msg);
            const div = document.getElementById('console-log');
            div.style.display = 'block';
            div.innerHTML += `> ${msg}<br>`;
            div.scrollTop = div.scrollHeight;
        }
        window.onerror = function(msg, source, lineno) {
            log(`ERROR: ${msg} at line ${lineno}`);
        };
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. SAFE 3D INIT ---
        log("Initializing 3D Engine...");
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // CREATE QUANTUM KNOT (Guaranteed to work)
        const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x00aaff, 
            wireframe: true,
            transparent: true, opacity: 0.6
        });
        const knot = new THREE.Mesh(geometry, material);
        scene.add(knot);

        // Inner Glow
        const coreGeo = new THREE.SphereGeometry(0.5, 16, 16);
        const coreMat = new THREE.MeshBasicMaterial({ color: 0x00aaff });
        const core = new THREE.Mesh(coreGeo, coreMat);
        scene.add(core);

        function animate() {
            requestAnimationFrame(animate);
            knot.rotation.x += 0.01;
            knot.rotation.y += 0.013;
            // Pulse core
            const s = 1 + Math.sin(Date.now() * 0.005) * 0.2;
            core.scale.set(s, s, s);
            renderer.render(scene, camera);
        }
        animate();
        log("3D Engine Running.");

        // --- 2. AUDIO & HAPTICS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(600, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        // --- 3. CONNECTION (PEERJS) ---
        log("Connecting to Network...");
        const peer = new Peer(); 
        let conn = null;

        peer.on('open', (id) => {
            log("ID Generated: " + id);
            // We just show the LAST 6 chars to keep it simple, 
            // but internally use the full ID for connection logic if needed,
            // or better yet, just display the full ID to be safe for now.
            // Let's shorten it for display but keep full id for safety.
            const shortID = id.split('-')[0].toUpperCase(); 
            document.getElementById('my-id').innerText = id; 
            document.getElementById('my-id').style.fontSize = "12px"; // Smaller font for long ID
        });

        peer.on('error', (err) => log("Peer Error: " + err.type));

        // CONNECT BUTTON
        document.getElementById('btn-link').addEventListener('click', () => {
            const pid = document.getElementById('partner-id').value;
            if(!pid) return alert("Enter ID");
            log("Connecting to " + pid);
            conn = peer.connect(pid);
            setupConn();
        });

        peer.on('connection', (c) => {
            conn = c;
            log("Incoming Connection!");
            setupConn();
        });

        function setupConn() {
            document.getElementById('status').innerHTML = "<span class='green-status'>CONNECTED & SECURE</span>";
            playTone();
            
            conn.on('data', (data) => {
                if(data.type === 'touch') triggerEffect(true);
            });
        }

        // --- 4. INTERACTION ---
        function triggerEffect(isRemote) {
            // Visual
            material.color.setHex(0xff0055); // Pink
            coreMat.color.setHex(0xff0055);
            
            // Audio/Haptic
            playTone();
            if(navigator.vibrate) navigator.vibrate(200);

            // Reset
            setTimeout(() => {
                material.color.setHex(0x00aaff); // Blue
                coreMat.color.setHex(0x00aaff);
            }, 300);

            // Send
            if(!isRemote && conn) conn.send({ type: 'touch' });
        }

        // TAP HANDLER
        document.getElementById('start-screen').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            if(audioCtx.state === 'suspended') audioCtx.resume();
            log("System Active.");
        });

        window.addEventListener('mousedown', () => triggerEffect(false));
        window.addEventListener('touchstart', (e) => {
            if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                triggerEffect(false);
            }
        });

    </script>
</body>
</html>
